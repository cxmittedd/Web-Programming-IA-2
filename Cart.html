<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart - Fresh Cuts</title>
    <link rel="stylesheet" href="Cart.css" />
  </head>

  <body>
    <h1>Your Cart</h1>

    <div class="cart-container">
      <table id="cartTable">
        <thead>
          <tr>
            <th>Service</th>
            <th>Price (JMD)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="cartItems"></tbody>
      </table>

      <h2 id="totalCost">Total: $0 JMD</h2>

      <button id="clearCartBtn">Clear Cart</button>
      <a href="Checkout.html"
        ><button id="checkoutBtn" class="checkout-btn">
          Proceed to Checkout
        </button></a
      >
    </div>

    <script>
      const KEY_PREFERRED = "cartItems";
      const KEY_LEGACY = "cart";
      const KEY_COUNT = "cartCount";

      function readRawCart() {
        try {
          const rawPreferred = localStorage.getItem(KEY_PREFERRED);
          if (rawPreferred) return JSON.parse(rawPreferred);

          const rawLegacy = localStorage.getItem(KEY_LEGACY);
          if (rawLegacy) return JSON.parse(rawLegacy);

          return [];
        } catch (e) {
          console.warn("Failed to parse cart JSON, resetting cart.", e);
          localStorage.removeItem(KEY_PREFERRED);
          localStorage.removeItem(KEY_LEGACY);
          return [];
        }
      }

      function saveRawCart(arr) {
        const json = JSON.stringify(arr);
        localStorage.setItem(KEY_PREFERRED, json);
        localStorage.setItem(KEY_LEGACY, json);

        localStorage.setItem(KEY_COUNT, String(arr.length));
      }

      function renderCart() {
        const cart = readRawCart();
        const tbody = document.getElementById("cartItems");
        const totalCostEl = document.getElementById("totalCost");

        tbody.innerHTML = "";
        if (!cart.length) {
          tbody.innerHTML =
            '<tr><td colspan="3" style="text-align:center; color:#666; padding:18px;">Your cart is empty.</td></tr>';
          totalCostEl.textContent = "Total: $0 JMD";

          localStorage.setItem(KEY_COUNT, "0");
          return;
        }

        let total = 0;
        cart.forEach((item, index) => {
          const priceNum = Number(item.price || 0);
          total += priceNum;

          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = item.name || "Service";
          tr.appendChild(tdName);

          const tdPrice = document.createElement("td");
          tdPrice.textContent = "$" + priceNum;
          tdPrice.style.textAlign = "right";
          tr.appendChild(tdPrice);

          const tdAction = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "Remove";
          btn.addEventListener("click", () => removeItem(index));
          tdAction.appendChild(btn);
          tdAction.style.textAlign = "center";
          tr.appendChild(tdAction);

          tbody.appendChild(tr);
        });

        totalCostEl.textContent = "Total: $" + total + " JMD";

        // keep count in storage

        localStorage.setItem(KEY_COUNT, String(cart.length));
      }

      // Remove single item by index

      function removeItem(index) {
        const cart = readRawCart();
        if (index >= 0 && index < cart.length) {
          cart.splice(index, 1);
          saveRawCart(cart);
          renderCart();
        }
      }

      // Clear full cart

      function clearCart() {
        if (!confirm("Clear your cart?")) return;
        localStorage.removeItem(KEY_PREFERRED);
        localStorage.removeItem(KEY_LEGACY);
        localStorage.setItem(KEY_COUNT, "0");
        renderCart();
      }

      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("clearCartBtn")
          .addEventListener("click", clearCart);
        renderCart();

        window.addEventListener("storage", (e) => {
          if (
            e.key === KEY_PREFERRED ||
            e.key === KEY_LEGACY ||
            e.key === KEY_COUNT
          ) {
            renderCart();
          }
        });
      });
    </script>
  </body>
</html>
